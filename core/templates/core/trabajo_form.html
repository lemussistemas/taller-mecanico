{% extends "core/base.html" %}
{% block title %}{% if object %}Editar Trabajo #{{ object.pk }}{% else %}Nuevo Trabajo{% endif %}{% endblock %}
{% block content %}
  <h1 class="text-3xl font-semibold mb-6">
    {% if object %}Editar Orden{% else %}Nueva Orden{% endif %}
  </h1>

  <form method="post" class="space-y-4 bg-white shadow rounded p-6" x-data="formsetHandler()">
    {% csrf_token %}
    {{ form.as_p }}

    <h2 class="text-xl mt-4 mb-2">Servicios</h2>
    <!-- Container de servicios -->
    <div id="services" class="space-y-4">
      {{ servicios.management_form }}
      {% for subform in servicios %}
      <div class="p-4 border rounded service-form">
        {{ subform.id }}
        {{ subform.as_p }}
        {% if subform.instance.pk %}
        <div class="flex items-center">
          {{ subform.DELETE }}
          <label class="ml-1 text-red-600" for="{{ subform.DELETE.id_for_label }}">Borrar</label>
        </div>
        {% endif %}
      </div>
      {% endfor %}
    </div>

    <button type="button" @click="addForm()"
            class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition">
      Agregar Servicio
    </button>

    <button type="submit"
            class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition">
      Guardar Orden
    </button>
  </form>

  <!-- Plantilla oculta para nuevos servicios -->
  <div id="empty-form" class="hidden">
    {% with sub=servicios.empty_form %}
    <div class="p-4 border rounded service-form">
      {{ sub.id }}
      {{ sub.as_p }}
      <!-- No mostrar checkbox en creaciÃ³n -->
    </div>
    {% endwith %}
  </div>

  <script>
    function formsetHandler() {
      return {
        totalForms: document.querySelector('[name="{{ servicios.prefix }}-TOTAL_FORMS"]'),
        addForm() {
          let total = parseInt(this.totalForms.value);
          let template = document.getElementById('empty-form').innerHTML.replace(/__prefix__/g, total);
          document.getElementById('services').insertAdjacentHTML('beforeend', template);
          this.totalForms.value = total + 1;
        }
      }
    }
  </script>
{% endblock %}
